import{u as F}from"./index-EJK1-8dv.js";import{u as fe}from"./index-LDJIlj3e.js";import{u as pe,d as he,l as ve,j as me}from"./coms-BGBaUFfq.js";import{bP as j,bQ as ye,bT as S,aM as _e,by as ke,bK as E,aA as b,bN as G,bO as D,bL as H,bH as J,bG as L}from"./ant1-FgANxHEo.js";import{I as be,h as ge,T as xe,m as Q}from"./ant2-F-VMf9eP.js";import{c as W,f as v,r as q,o as Ie,a6 as X,n as we,V as o,W as i,k as l,$ as a,u as e,G as r,X as c,F as p,a7 as B,a1 as f,Z as z,m as Se,ab as Z,a2 as ze}from"./vue-DoSrNxHp.js";const Ae={class:"pannel pt20 pl20 pb20 pr20 mt14 users-list-page"},Ce=c("span",{class:"txt-error"},"删除",-1),De=c("hr",{class:"mt20 mb20"},null,-1),Le={key:0,class:"f ac user-avatar"},Re={class:"ml4"},Me={class:"txt-ellipsis",style:{maxWidth:"100px"}},$e={class:"fs12 txt-grey"},Ke={class:"sugar-grey fs12"},Be={key:1},Ne={class:"sugar-grey fs12"},Pe={key:1},Te={key:0},Ye={key:1},Oe={class:"f mt20"},Ue={class:"roles-auth-tree"},Ve=c("div",null,[c("b",null,"编辑")],-1),Fe={class:"roles-auth-tree"},je=c("div",null,[c("b",null,"查看")],-1),Xe={__name:"index",setup(Ee){const N=pe(),A=he(),R=W(()=>N.preadmin);W(()=>N.user);const _=v([]),C=v(!1),ee=t=>{_.value=t},u=q({keyword:"",role:"",frozen:null}),M=v([]),$=v(!1),y=q({current:1,pageSize:12,total:0,showQuickJumper:!0,simple:!0,position:["bottomCenter"]}),K={normal:{name:"普通用户",color:"grey"},admin:{name:"管理员",color:"info"},super:{name:"超级管理员",color:"info"}},te=["女","男","保密"],ae=()=>{y.current=1,y.total=0},k=async()=>{try{$.value=!0;const t={current:y.current,pageSize:y.pageSize,fieldby:[],field:[]};u.role&&(t.fieldby.push("role"),t.field.push(u.role)),u.frozen&&(t.fieldby.push("frozen"),t.field.push(u.frozen)),u.keyword&&(t.keywordby="id,username,nickname",t.keyword=u.keyword),t.fieldby=t.fieldby.join(","),t.field=t.field.join(","),M.value=[],await F.list({query:t}).then(d=>{M.value=d.list||[],y.total=d.total})}finally{$.value=!1}},le=()=>{u.keyword="",u.role="",u.frozen=null,ae(),k()},se=()=>{k()},P=async t=>{J.confirm({title:"确认删除？",content:"删除后将无法恢复",centered:!0,onOk:async()=>new Promise((d,I)=>{F.del({ids:t}).then(()=>{L.success("删除成功"),se(),d()}).catch(h=>{console.error(h),L.error(h.message||"删除失败"),I()})})})},g=v(!1),T=v(A.roleAuth),Y=v(A.roleAuth),x=v([]),m=v([]),ne=async()=>{C.value=!0;const t=_.value;try{await fe({ids:t,body:{editabledRoleAuth:x.value,viewabledRoleAuth:m.value}}).then(()=>{k(),L.success("权限设置成功"),g.value=!1})}finally{C.value=!1}},O=t=>{T.value=A.roleAuth,Y.value=JSON.parse(JSON.stringify(A.roleAuth)).map(h=>(t.checked.includes(h.key)&&(h.disabled=!0),h));const d=new Set(t.checked),I=new Set([...t.checked,...m.value]);x.value=Array.from(d),m.value=Array.from(I)},oe=t=>{m.value=t.checked},ie=t=>{m.value=t.viewabledRoleAuth,O({checked:t.editabledRoleAuth}),_.value=[t._id],g.value=!0},de=async({key:t})=>{if(!_.value.length&&t!=="import")return L.error("未选中目标");switch(t){case"del":await P(_.value);break;case"auth":x.value=[],m.value=[],g.value=!0;break}},re=()=>{k()},ue=t=>{y.current=t.current,k()};return Ie(()=>{k()}),(t,d)=>{const I=X("MIcon"),h=X("RouterLink"),ce=we("depic");return o(),i(p,null,[l(e(ye),null,{default:a(()=>[l(e(j),null,{default:a(()=>[l(h,{to:`/${R.value}`},{default:a(()=>[l(I,{name:"dashboard",class:"mr6"}),r("控制台")]),_:1},8,["to"])]),_:1}),l(e(j),null,{default:a(()=>[r("用户管理")]),_:1})]),_:1}),c("div",Ae,[l(e(ge),{justify:"space-between"},{default:a(()=>[l(e(S),{size:"middle"},{default:a(()=>[l(e(_e),{loading:C.value},{overlay:a(()=>[l(e(ke),{onClick:de},{default:a(()=>[l(e(E),{key:"auth"},{default:a(()=>[r("设置角色权限")]),_:1}),l(e(E),{key:"del"},{default:a(()=>[Ce]),_:1})]),_:1})]),default:a(()=>[r(" 批量操作 ")]),_:1},8,["loading"]),l(h,{to:`/${R.value}/users/edit`},{default:a(()=>[l(e(b),{type:"primary"},{default:a(()=>[r("新增用户")]),_:1})]),_:1},8,["to"])]),_:1}),l(e(S),{size:"middle"},{default:a(()=>[l(e(be),{value:u.keyword,"onUpdate:value":d[0]||(d[0]=n=>u.keyword=n),placeholder:"用户ID/用户名"},null,8,["value"]),l(e(G),{value:u.role,"onUpdate:value":d[1]||(d[1]=n=>u.role=n),placeholder:"所有角色",style:{width:"120px"}},{default:a(()=>[l(e(D),{value:""},{default:a(()=>[r("所有角色")]),_:1}),(o(),i(p,null,B(K,(n,s)=>l(e(D),{key:s,value:s},{default:a(()=>[r(f(n.name),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"]),l(e(G),{value:u.frozen,"onUpdate:value":d[2]||(d[2]=n=>u.frozen=n),placeholder:"是否冻结",style:{width:"120px"}},{default:a(()=>[l(e(D),{value:!0},{default:a(()=>[r("冻结")]),_:1}),l(e(D),{value:!1},{default:a(()=>[r("正常")]),_:1})]),_:1},8,["value"]),l(e(b),{type:"primary",onClick:re},{default:a(()=>[r("搜索")]),_:1}),l(e(b),{onClick:le},{default:a(()=>[r("重置")]),_:1})]),_:1})]),_:1}),De,l(e(xe),{columns:[{title:"ID",dataIndex:"id"},{title:"角色",dataIndex:"role"},{title:"邮箱",dataIndex:"email",ellipsis:!0},{title:"上级用户ID",dataIndex:"pid"},{title:"性别",dataIndex:"sex"},{title:"IP",dataIndex:"IPs"},{title:"最近登录时间",dataIndex:"lastLogin"},{title:"注册时间",dataIndex:"_id"},{title:"安全等级",dataIndex:"security"},{title:"手机号",dataIndex:"phone"},{title:"状态",dataIndex:"frozen",align:"center",fixed:"right",width:70},{title:"操作",dataIndex:"ctrl",align:"right",fixed:"right",width:180}],"data-source":M.value,size:"small",loading:$.value,scroll:{x:1700},pagination:y,"row-selection":{selectedRowKeys:_.value,onChange:ee},rowKey:"_id",onChange:ue},{bodyCell:a(({column:n,record:s})=>{var U,V;return[n.dataIndex==="id"?(o(),i("div",Le,[s.avatar?(o(),z(e(H),{key:0},{icon:a(()=>[Se(c("img",null,null,512),[[ce,`${s.avatar}?100x100`]])]),_:2},1024)):(o(),z(e(H),{key:1,src:"/assets/img/avatar/avatar.jpg"})),c("div",Re,[c("div",Me,f(s.username),1),c("div",$e,"ID:"+f(s.id||"null"),1)])])):n.dataIndex==="role"?(o(),i("span",{key:1,class:Z(`sugar-${K[s.role].color}`)},f(K[s.role].name),3)):n.dataIndex==="email"?(o(),i(p,{key:2},[r(f(s.email||"-"),1)],64)):n.dataIndex==="pid"?(o(),i(p,{key:3},[(U=s.pid)!=null&&U.length?(o(),z(e(S),{key:0},{default:a(()=>[(o(!0),i(p,null,B(s.pid,w=>(o(),i("span",Ke,f(w),1))),256))]),_:2},1024)):(o(),i("span",Be,"-"))],64)):n.dataIndex==="sex"?(o(),i(p,{key:4},[r(f(te[s.sex]),1)],64)):n.dataIndex==="IPs"?(o(),i(p,{key:5},[(V=s.IPs)!=null&&V.length?(o(),z(e(S),{key:0},{default:a(()=>[(o(!0),i(p,null,B(s.IPs.slice(-3),w=>(o(),i("span",Ne,f(w),1))),256))]),_:2},1024)):(o(),i("span",Pe,"-"))],64)):n.dataIndex==="lastLogin"?(o(),i(p,{key:6},[s.lastLogin>0?(o(),i("span",Te,f(e(ve)(+`${s.lastLogin}000`,"YYYY-MM-DD hh:mm")),1)):(o(),i("span",Ye,"-"))],64)):n.dataIndex==="_id"?(o(),i(p,{key:7},[r(f(e(me)(s._id,"YYYY-MM-DD hh:mm")),1)],64)):n.dataIndex==="frozen"?(o(),i("span",{key:8,class:Z(`sugar-${s.frozen?"error":"success"}`)},f(s.frozen?"冻结":"正常"),3)):n.dataIndex==="phone"?(o(),i(p,{key:9},[r(f(s.phone||"-"),1)],64)):n.dataIndex==="ctrl"?(o(),z(e(S),{key:10},{default:a(()=>[l(h,{to:`/${R.value}/users/edit/${s.id}`},{default:a(()=>[l(e(b),{type:"primary",size:"small"},{default:a(()=>[r("编辑")]),_:1})]),_:2},1032,["to"]),l(e(b),{size:"small",disabled:s.id==1e4||!["super","admin"].includes(s.role),onClick:w=>ie(s)},{default:a(()=>[r("权限")]),_:2},1032,["disabled","onClick"]),l(e(b),{size:"small",disabled:s.id==1e4,danger:"",onClick:w=>P([s._id])},{default:a(()=>[r("删除")]),_:2},1032,["disabled","onClick"])]),_:2},1024)):ze("",!0)]}),_:1},8,["data-source","loading","pagination","row-selection"]),l(e(J),{open:g.value,"onUpdate:open":d[5]||(d[5]=n=>g.value=n),title:"角色权限",centered:"",confirmLoading:C.value,onOk:ne},{default:a(()=>[c("div",Oe,[c("div",Ue,[Ve,l(e(Q),{checkedKeys:x.value,"onUpdate:checkedKeys":d[3]||(d[3]=n=>x.value=n),showLine:{showLeafIcon:!1},treeData:T.value,"tree-node-filter-prop":"title",checkable:"",checkStrictly:"",multiple:"",selectable:!1,onCheck:O},null,8,["checkedKeys","treeData"])]),c("div",Fe,[je,l(e(Q),{class:"roles-auth-tree",checkedKeys:m.value,"onUpdate:checkedKeys":d[4]||(d[4]=n=>m.value=n),showLine:{showLeafIcon:!1},treeData:Y.value,"tree-node-filter-prop":"title",checkable:"",checkStrictly:"",multiple:"",selectable:!1,onCheck:oe},null,8,["checkedKeys","treeData"])])])]),_:1},8,["open","confirmLoading"])])],64)}}};export{Xe as default};
