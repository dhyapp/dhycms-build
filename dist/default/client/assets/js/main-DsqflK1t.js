import{e as V,V as $,W as I,u as m,X as o,F as Z,a7 as ye,ab as J,Y as Fe,k as h,$ as w,a1 as M,G as A,a2 as oe,f as S,c as ne,a0 as ke,p as ue,r as de,h as Be,o as Pe,y as De,j as Me,a6 as pe,n as Re,B as N,Z as se,m as Ae,J as Ee}from"./vue-DoSrNxHp.js";import{r as we,o as q,C as j,u as le,i as Oe,h as Ne}from"./coms-BJ4SXf9r.js";import{e as me}from"./index-fks0TXNb.js";import{ae as fe,bG as P,aA as G,bT as ve,bD as je,bA as Je,bE as Ve,bH as Ge}from"./ant1-FgANxHEo.js";import{T as be}from"./index-DMU2ysKL.js";import{C as qe,P as We,e as He,F as ge,I as he,o as Xe}from"./ant2-F-VMf9eP.js";const Qe=c=>we("/api/v1/admin/cloud/netpic",{method:"POST",body:JSON.stringify(c)}),Ye=c=>we("/api/v1/admin/cloud/sendInfo",{method:"POST",body:JSON.stringify(c)}),Ze={class:"cloud-upload-status-list"},Ke={key:0,class:"status-wrapper"},et={class:"f jb ac head"},tt=o("b",null,"上传进度",-1),at={class:"status-list scroll"},st={class:"left"},ot={class:"progress-wrapper"},nt={class:"f jb ac fs12 mt4"},lt={class:"nowrap txt-ellipsis"},rt={class:"right"},it=["onClick"],ct={__name:"statusList",setup(c){const d=V("uploadStatusList",[]),l=V("showUploadStatus",!1),p=r=>{var e;r.err=1,r.msg="已取消",(e=r.xhr)==null||e.abort()};return(r,e)=>($(),I("div",Ze,[m(l)&&m(d).length?($(),I("div",Ke,[o("div",et,[tt,o("span",{class:"close",onClick:e[0]||(e[0]=()=>l.value=!1)},"×")]),o("div",at,[($(!0),I(Z,null,ye(m(d),(t,x)=>($(),I("div",{key:x,class:"f ac item"},[o("div",st,[o("div",ot,[o("div",{class:J(["progress-bar",{done:t.err||t.ok}]),style:Fe({width:`${t.percent||0}%`,background:t.err?"var(--error)":"var(--success)"})},null,6)]),o("div",nt,[h(m(fe),{title:t.name,class:"filename"},{default:w(()=>[o("span",lt,M(t.name),1)]),_:2},1032,["title"]),o("span",null,[!t.ok&&t.loaded?($(),I(Z,{key:0},[A(M(m(q)(t.loaded))+"/",1)],64)):oe("",!0),A(M(t.sizeInfo||"处理中"),1)])])]),o("div",rt,[h(m(fe),{title:t.ok?"完成":t.err?t.msg||"已取消":"取消"},{default:w(()=>[o("span",{class:J(["fs11 cancel txt-ellipsis",{"txt-success":t.ok,"txt-error":t.err}]),onClick:y=>p(t)},M(t.ok?"完成":t.err?t.msg||"已取消":"取消"),11,it)]),_:2},1032,["title"])])]))),128))])])):m(d).length?($(),I("div",{key:1,class:"status-show-btn",onClick:e[1]||(e[1]=()=>l.value=!0)},"»")):oe("",!0)]))}},W="code!",ut=1024*1024*5-16-W.length,dt=1024*1024*200-16-W.length,_e={pic:["image/jpeg","image/jpg","image/png","image/apng","image/gif","image/webp","image/ico"],video:["video/mp4","video/x-flv","video/webm","video/quicktime"],audio:["audio/mpeg","audio/x-wav"],app:["application/octet-stream","application/x-msdownload","application/x-apple-diskimage","application/vnd.android.package-archive"],zip:["application/x-zip-compressed","application/x-gzip"]},xe=c=>{for(const d in _e)if(_e[d].includes(c))return d},pt=c=>new Promise(d=>{const l=new Image;l.src=URL.createObjectURL(c),l.onload=()=>{d({width:l.width,height:l.height,ratio:l.width/l.height})}}),Se=async({files:c,imgMaxSize:d,fileMaxSize:l})=>{const p=[],r=d?d-16-W.length:ut,e=l?l-16-W.length:dt;for(let t=0;t<c.length;t++){const x=xe(c[t].type);if(p[t]={name:c[t].name,size:c[t].size,sizeInfo:q(c[t].size),type:c[t].type},!x)p[t].err=1,p[t].msg="格式有误";else if(x==="pic")if(c[t].size>r)p[t].err=1,p[t].msg=`超过${q(r)}M`;else{const y=await pt(c[t]);(y.width>1e4||y.height>1e4)&&(p[t].err=1,p[t].msg="超过1万像素"),y.ratio<1/20&&(p[t].err=1,p[t].msg="宽高比过大")}else c[t].size>e&&(p[t].err=1,p[t].msg=`超过${q(e)}M，大文件推荐使用桌面端`)}return p},mt=function(c){for(var d=c.words,l=c.sigBytes,p=new Uint8Array(l),r=0;r<l;r++){var e=d[r>>>2]>>>24-r%4*8&255;p[r]=e}return p},ft=(c,d)=>{const l=j.enc.Utf8.parse([...d].reverse().join("")),p=j.lib.WordArray.create(c);d=j.enc.Utf8.parse(d);const e=j.AES.encrypt(p,d,{iv:l,mode:j.mode.CBC,padding:j.pad.Pkcs7}).ciphertext;return mt(e)},$e=({file:c,name:d,type:l,key:p})=>new Promise((r,e)=>{l=l||c.type,d=d||c.name;const t=new FileReader;t.readAsArrayBuffer(c),t.onload=async()=>{const x=new Uint8Array(t.result),y=ft(x,p);let T=new Blob([y],{type:l});const U=new Blob([new TextEncoder("utf-8").encode(W)]);let f=new File([U,T],d,{type:l});r(f)},t.onerror=e}),vt={class:"cloud-upload"},gt={class:"upload-btn"},ht={__name:"localUpload",emits:["uploaded","error","beforeUpload"],setup(c,{emit:d}){const l=S(null),p=le(),r=ne(()=>p.cloud||{}),e=V("uploadStatusList",[]),t=V("showUploadStatus",!1),x=d,y=()=>{const U=e.value.length;for(let f=0;f<U;f++)if(!e.value[f].err&&!e.value[f].ok)return;return x("uploaded"),l.value.value="",!0},T=async U=>{const f=U.target.files;if(!(f!=null&&f.length))return;const B=new be({maxTasks:3,maxRetry:0});if(x("beforeUpload",f),f.length>100)return P.error("上传文件过多");e.value=await Se({files:f}),t.value=!0;for(let s=0;s<f.length;s++)e.value[s].err||e.value[s].ok||B.add(()=>new Promise(async(z,v)=>{const E=r.value.encoded&&r.value.key?await $e({file:f[s],key:r.value.key}):f[s],b=new XMLHttpRequest,k=new FormData,n=g=>{e.value[s].err=1,e.value[s].msg=e.value[s].msg||(g==null?void 0:g.msg)||(g==null?void 0:g.message)||"上传失败",y(),x("error",{status:e.value[s]}),v(e.value[s])};k.append("file",E),e.value[s].xhr=b,b.onerror=n,b.onabort=n,b.upload.onprogress=g=>{g.lengthComputable&&(e.value[s].percent=g.loaded/g.total*100,e.value[s].loaded=g.loaded)},b.onload=()=>{if(b.status>=200&&b.status<300)try{const g=JSON.parse(Oe(b.response));g.ok?(e.value[s].percent=100,e.value[s].ok=1,e.value[s].msg="完成",y(),z(e.value[s])):n(g)}catch(g){console.warn(g),n(g)}else n({msg:b.statusText})},b.open("post","/api/v1/admin/upload"),b.send(k)}))};return(U,f)=>($(),I("div",vt,[o("span",gt,[ke(U.$slots,"default"),o("input",{ref_key:"filesInput",ref:l,type:"file",name:"files",multiple:"",onChange:T},null,544)])]))}},_t={class:"cloud-upload"},yt={class:"upload-btn"},kt={__name:"TGUpload",emits:["uploaded","error","beforeUpload"],setup(c,{emit:d}){const l=S(null),p=le(),r=ne(()=>p.cloud||{}),e=V("uploadStatusList",[]),t=V("showUploadStatus",!1),x=d,T=`${`${r.value.tgDomain}/bot${r.value.tgToken}`}/sendDocument`,U=()=>{const B=e.value.length;for(let s=0;s<B;s++)if(!e.value[s].err&&!e.value[s].ok)return;return x("uploaded"),l.value.value="",!0},f=async B=>{const s=B.target.files;if(!(s!=null&&s.length))return;if(!r.value.tgToken)return P.error("未配置Telegram Bot Token，无法云上传");if(!r.value.tgChatID)return P.error("未配置Telegram Chat ID，无法云上传");const z=new be({maxTasks:3,maxRetry:0});if(x("beforeUpload",s),s.length>100)return P.error("上传文件过多");e.value=await Se({files:s,fileMaxSize:1024*1024*20}),t.value=!0;for(let v=0;v<s.length;v++)e.value[v].err||e.value[v].ok||z.add(()=>new Promise(async(E,b)=>{const k=r.value.encoded&&r.value.key?await $e({file:s[v],key:r.value.key}):s[v],n=new XMLHttpRequest,g=new FormData,F=_=>{e.value[v].err=1,e.value[v].msg=e.value[v].msg||(_==null?void 0:_.msg)||(_==null?void 0:_.message)||"上传失败",U(),x("error",{status:e.value[v]}),b(e.value[v])};g.append("chat_id",r.value.tgChatID),g.append("document",k),e.value[v].xhr=n,n.onerror=F,n.onabort=F,n.upload.onprogress=_=>{if(!_.lengthComputable)return;const L=_.loaded/_.total*100;e.value[v].percent=L>95?95:L,e.value[v].loaded=_.loaded},n.onload=async()=>{var _,L;if(n.status>=200&&n.status<300)try{const D=JSON.parse(n.response),H=(L=(_=D.result)==null?void 0:_.document)==null?void 0:L.file_id;if(!H)return F({msg:D.description||D.statusText});e.value[v].msg="记录URL";const O=k.name.includes(".")?k.name.split(".").pop():"";await Ye({name:k.name.replace(new RegExp(`\\.${O}$`),""),ext:O,size:k.size,platform:3,pid:xe(k.type),src:`tg/${H}.${O}`}).then(()=>{e.value[v].percent=100,e.value[v].ok=1,e.value[v].msg="完成",U(),E(e.value[v])}).catch(X=>{F(X)})}catch(D){console.warn(D),F(D)}else F({msg:res.statusText})},n.open("post",T),n.send(g)}))};return(B,s)=>($(),I("div",_t,[o("span",yt,[ke(B.$slots,"default"),o("input",{ref_key:"filesInput",ref:l,type:"file",name:"files",multiple:"",onChange:f},null,544)])]))}},wt={class:"cloud-main"},bt={class:"cloud-toolsbar f ac"},xt={class:"f ac"},St=o("span",{class:"divider-vertical"},null,-1),$t=o("span",{class:"divider-vertical"},null,-1),Ct=o("span",{class:"f ac remove"},[o("span",{class:"mr4 fs20"},"×"),A("删除")],-1),Ut=o("hr",{class:"mb10"},null,-1),zt=["title","onClick"],It={class:"img-box"},Lt=["alt","onLoad"],Tt={class:"tags"},Ft={class:"info"},Bt={class:"f"},Pt={class:"name txt-ellipsis"},Dt={class:"ext"},Mt={class:"f ac jb txt-grey fs11 mt4"},Rt={class:"f ac right"},At=["onClick"],Et=["onClick"],qt={__name:"main",props:{modelValue:{type:Array,default:()=>[]}},emits:["update:modelValue"],setup(c,{emit:d}){const l=d,p=S(null),r=le(),e=ne(()=>r.cloud||{}),t=["本地","网络","TG","TGCF"],x={video:"video-file",audio:"audio",app:"app",zip:"zip"},y=S([]),T=S(!0),U=S(!1),f=S(!1),B=S([]),s=S(!1);ue("uploadStatusList",B),ue("showUploadStatus",s);const z=de({current:1,pageSize:20,total:0}),v=S(!1),E=S(null),b=S(!1),k=de({src:"",alt:""}),n=S([]);let g=!1,F=!1,_=-1;Be(()=>{l("update:modelValue",n.value.map(u=>{const a=y.value.findIndex(C=>C._id===u);return y.value[a]}))});const L=async()=>{T.value=!0,await me.list({query:{current:z.current,pageSize:z.pageSize}}).then(u=>{y.value=(u.list||[]).map(a=>{switch(a.platform){case 0:a.src=`/${a.src}?180`;break;case 2:a.tgSrc=`${e.value.tgDomain}/${a.src}`;break;case 3:a.cfSrc=`${e.value.staticDomain}/${a.src}`;break}return a}),z.total=u.total||0}),T.value=!1},D=async()=>{if(n.value.length===0)return P.error("未选中删除目标");try{U.value=!0,await me.del({ids:n.value}).then(()=>{P.success("删除成功"),L(),te.value=!1})}finally{U.value=!1}},H=async()=>{try{b.value=!0,await E.value.validate(),await Qe(Ee(k)).then(()=>{P.success("添加成功"),L(),k.src="",k.alt="",v.value=!1})}finally{b.value=!1}},O=()=>{f.value=!0},X=()=>{L(),f.value=!1},K=S(""),ee=S(!1),Ce=async u=>{K.value=u.blobSrc||u.src,ee.value=!0},Ue=()=>{K.value="",ee.value=!1},ze=u=>{let a;const C=location.origin;switch(u.platform){case 0:a=`${C}${u.src}`;break;case 2:a=`${e.value.tgDomain}/${u.src}`;break;case 3:a=`${e.value.staticDomain}/${u.src}`;break;default:a=u.src}Ne(a).then(()=>P.success("链接复制成功")).catch(()=>P.error("链接复制失败"))},Ie=(u,a)=>{if(g){const C=n.value.findIndex(R=>R===u._id);C>-1?n.value.splice(C,1):n.value.push(u._id)}else if(F){const C=a>=_;let R=C?y.value.slice(_,a+1):y.value.slice(a,_+1);C||(R=R.reverse()),R.forEach(Q=>{n.value.findIndex(ae=>ae===Q._id)===-1&&n.value.push(Q._id)})}else n.value[0]===u._id?n.value=[]:n.value=[u._id];_=a},te=S(!1),Le=u=>{u.target.checked?n.value=y.value.map(a=>a._id):n.value=[]},re=u=>{u.key==="Control"&&navigator.platform.indexOf("Mac")===-1||u.key==="Meta"?g=!0:u.key==="Shift"&&(F=!0)},ie=()=>{g=!1,F=!1,_=-1},ce=()=>{n.value=[]},Te=(u,a)=>{a.blobSrc=u.target.src};return Pe(()=>{De(()=>{const u=p.value.offsetWidth-24,C=Math.floor(u/176);z.pageSize=C*3,L()}),document.addEventListener("keydown",re),document.addEventListener("keyup",ie),document.addEventListener("click",ce)}),Me(()=>{document.removeEventListener("keydown",re),document.removeEventListener("keyup",ie),document.removeEventListener("click",ce)}),(u,a)=>{const C=pe("MIcon"),R=pe("MIconJs"),Q=Re("depic");return $(),I(Z,null,[o("div",wt,[o("div",bt,[o("div",xt,[h(m(G),{type:"text",onClick:a[1]||(a[1]=N(()=>{},["stop"]))},{default:w(()=>[h(m(qe),{checked:te.value,"onUpdate:checked":a[0]||(a[0]=i=>te.value=i),onChange:Le},{default:w(()=>[A("全选")]),_:1},8,["checked"])]),_:1}),St,h(ht,{class:J({"event-none":f.value}),onBeforeUpload:O,onUploaded:X},{default:w(()=>[h(m(G),{type:"text",loading:f.value},{default:w(()=>[h(C,{name:"upload",class:"mr4"}),A("本地上传 ")]),_:1},8,["loading"])]),_:1},8,["class"]),h(kt,{class:J({"event-none":f.value}),onBeforeUpload:O,onUploaded:X},{default:w(()=>[h(m(G),{type:"text",loading:f.value},{default:w(()=>[h(C,{name:"cloudup",class:"mr4"}),A("云上传 ")]),_:1},8,["loading"])]),_:1},8,["class"]),h(m(G),{type:"text",onClick:a[2]||(a[2]=N(()=>v.value=!0,["stop"]))},{default:w(()=>[h(C,{name:"earth",class:"mr4"}),A("网络资源 ")]),_:1}),$t,h(m(We),{title:"确认删除？","cancel-text":"取消","ok-text":"删除",onClick:a[3]||(a[3]=N(()=>{},["stop"])),onConfirm:D},{default:w(()=>[h(m(G),{type:"text",loading:U.value},{default:w(()=>[Ct]),_:1},8,["loading"])]),_:1})])]),Ut,o("div",{ref_key:"bodyRef",ref:p,class:J(["cloud-body",{"cloud-body-loading":T.value}])},[y.value.length?($(),se(m(je),{key:0,spinning:T.value},{default:w(()=>[h(m(ve),{size:"middle",wrap:""},{default:w(()=>[($(!0),I(Z,null,ye(y.value,(i,ae)=>($(),I("div",{key:i._id,class:J(["item",{active:n.value.indexOf(i._id)>-1}]),title:`${i.name}.${i.ext}`,onClick:N(Y=>Ie(i,ae),["stop"])},[o("div",It,[i.pid==="pic"?Ae(($(),I("img",{key:0,alt:i.alt,onLoad:Y=>Te(Y,i)},null,40,Lt)),[[Q,i.src]]):($(),se(R,{key:1,name:x[i.pid]},null,8,["name"])),o("div",Tt,[h(m(ve),null,{default:w(()=>[o("span",null,M(t[i.platform]),1)]),_:2},1024)])]),o("div",Ft,[o("div",Bt,[o("div",Pt,M(i.name),1),o("div",Dt,"."+M(i.ext),1)]),o("div",Mt,[o("span",null,M(i.size>0?m(q)(i.size):"未知"),1),o("div",Rt,[i.pid==="pic"?($(),I("span",{key:0,onClick:N(Y=>Ce(i),["stop"])},"预览",8,At)):oe("",!0),o("span",{onClick:N(Y=>ze(i),["stop"])},"复制链接",8,Et)])])])],10,zt))),128))]),_:1})]),_:1},8,["spinning"])):($(),se(m(Je),{key:1,class:"mt30 pt30",description:"暂无资源"}))],2),h(m(Ve),{showQuickJumper:"",simple:"",current:z.current,"onUpdate:current":a[4]||(a[4]=i=>z.current=i),pageSize:z.pageSize,"onUpdate:pageSize":a[5]||(a[5]=i=>z.pageSize=i),total:z.total,onChange:L},null,8,["current","pageSize","total"])]),h(m(Ge),{open:v.value,"onUpdate:open":a[8]||(a[8]=i=>v.value=i),centered:"",title:"添加网络图片","cancel-text":"取消","ok-text":"添加",confirmLoading:b.value,onOk:H},{default:w(()=>[h(m(He),{ref_key:"netpicFormRef",ref:E,model:k,"label-col":{span:4},"wrapper-col":{span:20},class:"pt30 pb10"},{default:w(()=>[h(m(ge),{label:"资源链接",name:"src",rules:[{required:!0,message:"资源链接不能为空"}]},{default:w(()=>[h(m(he),{placeholder:"https://",value:k.src,"onUpdate:value":a[6]||(a[6]=i=>k.src=i)},null,8,["value"])]),_:1}),h(m(ge),{label:"资源描述",name:"alt"},{default:w(()=>[h(m(he),{placeholder:"请输入资源描述",value:k.alt,"onUpdate:value":a[7]||(a[7]=i=>k.alt=i)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","confirmLoading"]),h(ct),h(m(Xe),{style:{display:"none"},src:K.value,preview:{visible:ee.value,onVisibleChange:Ue}},null,8,["src","preview"])],64)}}};export{qt as _};
