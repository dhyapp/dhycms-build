import{c as f,ae as K,f as w,w as R,o as A,a6 as N,W as b,k as n,$ as r,u as o,X as S,F as v,V as u,G as m,Z as x,a7 as D}from"./vue-DoSrNxHp.js";import{u as F,d as U}from"./coms-BJ4SXf9r.js";import{_ as H}from"./card-sfuo-F3J.js";import{g as W,i as $}from"./dhy-CPC2JIDw.js";import{bP as I,bQ as Q,bU as L,bW as X,bV as Y,bA as B,bD as Z,bG as y}from"./ant1-FgANxHEo.js";import"./ant2-F-VMf9eP.js";const j={class:"pannel mt14 template-page"},q={class:"pb20 pl20 pr20 pt20"},z={key:0,class:"f fw list"},oe={__name:"market",setup(J){const E=F(),p=U(),T=f(()=>E.preadmin),V=K(),h=w("templates/market"),_=w(!1),d=w([]),P=["free","pro","plus"],C=f(()=>p.config.dhy.gateway||""),g=f(()=>p.templates),M=f(()=>{for(const a of p.templates)if(a.newestVersion&&a.newestVersion>a.version)return!0;return!1});R(h,a=>{V.push(`/${T.value}/${a}`)});const k=async()=>{try{_.value=!0,await W("template").then(a=>{var l;d.value=((l=a==null?void 0:a.list)==null?void 0:l.map((t,i)=>{var e;if((e=g.value)!=null&&e.length){const s=g.value.findIndex(c=>c.name===t.key);if(s>-1){const c=g.value[s];t.hasNew=t.version>c.version,t.installed=!0}}return t.controls=[{label:t.installed?"已安装":"安装",key:"install",class:t.installed?"txt-grey event-none":"",product:t,productIndex:i}],t.hasNew&&t.controls.push({label:"更新",key:"update",class:"txt-success",product:t,productIndex:i}),t}))||[]})}finally{_.value=!1}},G=async({key:a,record:l})=>{const t=y.loading(),i={install:"安装",update:"更新"};try{switch(a){case"install":if(!l.installed){const s=d.value[l.productIndex].controls[0];s.label="安装中..",s.class="txt-grey event-none",await $({productId:l.product.id}).then(c=>{s.label="已安装",y.success("安装成功"),c.templates&&(p.templates=c.templates),k()}).catch(c=>{console.error(c),s.label="安装",s.class=""})}break;case"update":let e=d.value[l.productIndex].controls[1];e.label="更新中..",e.class="txt-grey event-none",await $({productId:l.product.id}).then(s=>{y.success("更新成功"),s.templates&&(p.templates=s.templates),k()}).catch(s=>{console.error(s),e.label="更新",e.class=""});break}}catch(e){console.error(e),y.error((e==null?void 0:e.msg)||(e==null?void 0:e.message)||`${i[a]}操作失败`)}finally{t()}};return A(()=>{k()}),(a,l)=>{const t=N("MIcon"),i=N("RouterLink");return u(),b(v,null,[n(o(Q),null,{default:r(()=>[n(o(I),null,{default:r(()=>[n(i,{to:`/${T.value}`},{default:r(()=>[n(t,{name:"dashboard",class:"mr6"}),m("控制台")]),_:1},8,["to"])]),_:1}),n(o(I),null,{default:r(()=>[m("模板管理")]),_:1}),n(o(I),null,{default:r(()=>[m("模板市场")]),_:1})]),_:1}),S("div",j,[n(o(Y),{activeKey:h.value,"onUpdate:activeKey":l[0]||(l[0]=e=>h.value=e)},{default:r(()=>[n(o(L),{key:"templates",tab:"模板列表"}),n(o(L),{key:"templates/market"},{tab:r(()=>[M.value?(u(),x(o(X),{key:0,count:"New",numberStyle:{backgroundColor:"var(--success)"},offset:[18,0]},{default:r(()=>[m("模板市场")]),_:1},8,["numberStyle"])):(u(),b(v,{key:1},[m("模板市场")],64))]),_:1})]),_:1},8,["activeKey"]),S("div",q,[n(o(Z),{spinning:_.value,style:{minHeight:"300px",width:"100%"}},{default:r(()=>[d.value.length?(u(),b("div",z,[(u(!0),b(v,null,D(d.value,e=>(u(),x(H,{key:e.id,type:"template",poster:e.poster?`${C.value}${e.poster}`:"",title:e.title,auth:P[e.authLevel],description:e.brif,controls:e.controls,version:e.version,price:e.price>0?`${e.price}U`:"免费",tag:e.hasNew?"最新":"",tagType:"success",onClick:G},null,8,["poster","title","auth","description","controls","version","price","tag"]))),128))])):(u(),x(o(B),{key:1,image:o(B).PRESENTED_IMAGE_SIMPLE,description:"暂无市场模板"},null,8,["image"]))]),_:1},8,["spinning"])])])],64)}}};export{oe as default};
