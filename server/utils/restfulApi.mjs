function O(){const{app:y,route:b}=this,{commonModels:q}=y.config.mongodb;let u,d;u=b.split(/[\/\\]/).pop(),u=`${u[0].toUpperCase()}${u.slice(1)}`,d=q.includes(u)?y.db.common:y.db.ego;const p=(s,e="",t)=>{s=s.split(","),e=e.split(","),s.forEach((r,n)=>{if(!r)return;const o=/^(ne|in|nin|gt|lt|gte|lte):(.+)/;if(o.test(e[n])){let[i,c,l]=e[n].match(o);["in","nin"].includes(c)&&(l=l.split("|")),t({[`$${c}`]:l},r)}else t(e[n],r)})},f=s=>{const{fieldby:e="",field:t="",orby:r="",or:n="",keywordby:o="",keyword:i=""}=s.request.query,c={},l=()=>{c.$or||(c.$or=[])};return e&&p(e,t,(a,m)=>{c[m]=a}),r&&(l(),p(r,n,(a,m)=>{c.$or.push({[m]:a})})),o&&(l(),p(o,i,(a,m)=>{typeof a=="object"?c.$or.push({[m]:a}):c.$or.push({[m]:new RegExp(a||i,"i")})})),c},h=s=>{const{sortby:e,sort:t}=s.request.query,r={};return e&&p(e,t,(n,o)=>{r[o]=n?parseInt(n):-1}),r._id=-1,r},$=(s,e)=>{const{joinby:t,join:r}=s.request.query;return t&&p(t,r,(n,o)=>{e.populate(o,n||"")}),e},g=s=>/^[a-z0-9]{24}$/.test(s);return{gets:async s=>{try{let{current:e=1,pageSize:t=20,filter:r=""}=s.request.query;const n=f(s),o=h(s);let i=0;e=parseInt(e),t=t>1e3?1e3:parseInt(t),i=(e-1)*t;const c=d.models[u].find(n,r).sort(o).skip(i).limit(t),[l,a]=await Promise.all([$(s,c),d.models[u].countDocuments(n)]);return{list:l,current:e,pageSize:t,total:a}}catch(e){return{err:2,msg:e.message||"\u67E5\u8BE2\u5931\u8D25"}}},get:async s=>{try{const{id:e}=s.request.params,{filter:t=""}=s.request.query,r=h(s),n=f(s);g(e)?n._id=e:e&&e!=="0"&&(n.id=e);const o=d.models[u].findOne(n,t).sort(r);return await $(s,o)}catch(e){return{err:2,msg:e.message||"\u6570\u636E\u83B7\u53D6\u5931\u8D25"}}},post:async s=>{const{body:e}=s.request;return!e||!(e instanceof Object)?s.status=400:await d.models[u].create(e).then(t=>t).catch(t=>{if(console.error(t),t.keyValue){const r={name:"\u540D\u79F0",id:"ID"},n=Object.keys(t.keyValue);return{err:1,msg:`\u5DF2\u5B58\u5728\u76F8\u540C${r[n[0]]||"\u6570\u636E"}:${t.keyValue[n[0]]}`}}else return{err:1,msg:t.message||"\u6DFB\u52A0\u6570\u636E\u5931\u8D25"}})},put:async s=>{try{const{id:e}=s.request.params,{body:t}=s.request;if(!t||!(t instanceof Object))return s.status=400;const{ids:r,fieldby:n="_id"}={...t},o=r?.length>0;delete t.ids,delete t.fieldby;const i=f(s);if(o?i[n]={$in:r}:g(e)?i._id=e:e&&e!=="0"&&(i.id=e),Object.keys(i).length===0)return{err:1,msg:"\u67E5\u8BE2\u5B57\u6BB5\u4E0D\u80FD\u4E3A\u7A7A"};const c=await d.models[u][o?"updateMany":"updateOne"](i,t,{upsert:t._upsert});return c.matchedCount||c.upsertedCount?{ok:1}:{err:1,msg:"\u8D44\u6E90\u66F4\u65B0\u5931\u8D25"}}catch(e){return{err:2,msg:e.message||"\u8D44\u6E90\u66F4\u65B0\u5931\u8D25"}}},delete:async s=>{try{const{id:e}=s.request.params,{body:t={}}=s.request,{ids:r,fieldby:n="_id"}={...t},o=r?.length>0;delete t.ids,delete t.fieldby;const i={...f(s),...t};return o?i[n]={$in:r}:g(e)?i._id=e:e&&e!=="0"&&(i.id=e),Object.keys(i).length===0?{err:1,msg:"\u5220\u9664\u5B57\u6BB5\u4E0D\u80FD\u4E3A\u7A7A"}:(await d.models[u][o?"deleteMany":"deleteOne"](i)).deletedCount?{ok:1}:{err:1,msg:"\u8D44\u6E90\u5220\u9664\u5931\u8D25"}}catch(e){return{err:2,msg:e.message||"\u8D44\u6E90\u5220\u9664\u5931\u8D25"}}}}}export{O as default};
